<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.0 on Sun Sep 16 16:53:37 2012 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>pp_titanbrowse_gui__define.pro (Documentation for source/)</title>

    
    <style type="text/css" media="all">
            /* setup page */
      body { font-family: Helvetica, sans-serif; font-size: 12pt; margin: 0; padding: 0; }
      div.content { padding: 1em; }
      p { line-height: 1.4; }
      td p { padding-bottom: 0.5em; }
      img { border: 0; }
      
      /* link styles */
      a { text-decoration: none; }
      a:link, a:visited { color: #0000FF; }
      a:hover, a:focus { background: yellow; border-bottom: 1emx dotted #303099; }
      
      /* dir-overview styles */
      dt.filename { margin-top: 0.5em; }
      dl.file_listing { margin-left: 1em; }
      
      /* titles */
      h1, h2, h3, h4 { font-weight:normal; color: #871E31; margin-top: 1.5em; }
      h4 { margin-bottom: 0.25em; }
      .center { margin-left: auto; margin-right: auto; }
      .small { font-family: Verdana, Helvetica, sans-serif; font-size: 90%; }
      .smaller { font-family: Verdana, Helvetica, sans-serif; font-size: 80%; }
      .smallest { font-family: Verdana, Helvetica, sans-serif; font-size: 70%; }
      h1.basename { margin-top: 0; margin-bottom: 0; }
      h1.basename span.file-attributes { font-size: 70%; margin-left: 3em; color: #384806; }
      h2.directory { font-size: 90%; margin-bottom: 0; }
      h2.routine-name { margin-top: 0; margin-bottom: 0; }
      p.categories { color: #384806; margin-top: 0; }
      span.file_attribute { float: right; color: #384806; margin: 0 0 1em 3em; }
      div#file_comments { margin-top: 1em; }
      
      div.routine-details { border: 1px dotted #C0C0C0; margin-top: 1em; padding: 1em; }
      span.routine-attributes { font-size: 70%; margin-left: 3em; color: #384806; }
      div.details dt { color: #871E31; margin-left: 2em; }
      div.details dt span { color: #384806; margin-left: 2em; }
      div.details dd { margin: 0.5em 2em 1em 4em; }
      a.top { 
      	font-family: Verdana, Helvetica, sans-serif; 
      	font-size: 8pt; 
      	font-weight: bold;
      	color: #5070ff; 
      	text-transform: uppercase; 
      	float: right; 
      	margin-left: 1em;
      }
      
      /* comments */
      .pre { white-space: pre; }
      
      /* code styles */
      code { font-family: Monaco, "Courier New", Courier, monospace; font-size: 95%; }
      code.listing { white-space: pre; display: block; margin: 0.75em 0 0.75em 0; padding: 0 3em 0 1em; line-height: 1.4em; }
      code.source { white-space: pre; display: block; }
      code.source span.comments { color: #408080; }
      .syntax { margin-top: 1em; margin-left: 1.5em; text-indent: -1.5em; }
      .var { font-style: italic; } 
      .argument { } /* white-space: nowrap; does not work in Safari (and sometimes not even in Firefox) */
      
      dl.routine-summary dt { margin-bottom: 0.25em; }
      dl.routine-summary dd { margin-bottom: 0.5em; margin-left: 2em; }
      
      /* general styles */
      ul li { list-style-type: none; }
      table { empty-cells: show; }
      thead { color: #871E31; }
      dd { margin-bottom: 0.35em; }
      input, textarea { background: #F3F6ED; border: #E1D6C6 1px solid; padding: 2px 1em 2px 0.5em; }
      input.text { background: #FFFFC0; }
      
      div.note { margin: 1em 2em 1em 2em; background: #EFEFEF; border: 1px #A0A0A0 dotted; padding: 0 1em 0 1em; }
      p.indent { margin-left: 2em; }
      
      /* An attribute table is a vertical list of name-value pairs. */
      table.box { 
        background: #EFEFEF; 
        border: 1px #A0A0A0 dotted; 
        padding-top: 0.75em;
        padding-bottom: 0.75em; 
      }
      table.attribute { padding-left: 0.75em; padding-right: 0.75em; }
      table td { vertical-align: top; }
      table.attribute p { margin: 0; }
      table td.name { font-style: normal; padding-right: 1.5em; }
      ul.fieldslist { padding-top: 0; color: #909090; }
      ul.fieldslist li { margin-bottom: 0.25em; }
      span.fieldname { color: #000000; }
      
      dl.attribute dt { color: #990000; }
      
      /* header/navbar styles */
      div.header { padding: 2em 2em 0 2em; background: #9E9D7B; border-bottom: 2px #262626 solid; }
      div.header h1 { color: white; margin:0; font-weight: normal; }
      div.header h2 { color: white; margin-top: 0; margin-bottom: 1em; font-weight: normal; font-style: italic; font-size: 100%; }
      table.navbar { background: #CCC097; margin: 0; padding: 0; border-bottom: 1px #262626 dotted; width: 100%; }
      table.navbar td { padding: 4px 0.5em 3px 0.5em; white-space: nowrap; vertical-align: top; }
      table.navbar td.flexible { width: 100%; text-align: right; padding-right: 1em; white-space: nowrap; }
      table.navbar td.selected { background: #262626; }
      table.navbar td.selected, table.navbar td.selected a { color: white; }
      table.navbar a:hover, table.navbar a:focus { background: inherit; border-bottom: 1px solid #303099; }
      p.localnavbar { text-align: right; margin: 0.2em 1em 0.2em 0.2em; padding: 0; }
      
      /* CSS graphics styles */
      div.box { 
        margin-left: 0.25em; 
        display: inline-block; 
        width: 0.9em; 
        height: 0.9em; 
        vertical-align: -1px;
      }
      .red { background-color: #A00; }
      .orange { background-color: #F40; }
      .green { background-color: #480; }
      
      /* index styles */
      span.index_type { margin-left: 1em; }
      dl.index_listing dd { margin-bottom: 0.5em; margin-left: 2em; }
      dl.index_listing dd p { margin-top: 0.2em; margin-bottom: 0em; }
      
      /* search styles */
      fieldset { border: #ddd 1px solid; padding: 1em; margin-top: 3em; }
      legend { color: #871E31; font-size: 120%; }
      label { white-space: nowrap; }
      p.description { margin: 2em 2em 1em 2em; }
      form table td.name { vertical-align: middle; }
            
      /* footer styles */
      div.footer { padding: 0.5em 1em 0.5em 1em; background: #EFEFEF; border-top: 1px #A0A0A0 dotted; }
      div.footer table { width: 100%; }
      div.footer td.right { text-align: right; }

    </style>
    <style type="text/css" media="print">
            p.localnavbar { display: none; }
      
      div.header { background: white; }
      div.header h1 { color: black; }
      div.header h2 { color: black; }

    </style>
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="pp_titanbrowse_gui__define.pro (Documentation for source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;+</span>
<span class="comments">; :Uses: pp_editablecube__define, pp_getcubeheadervalue, pp_extractfields, pp_setcubeheadervalue, pp_readcube__define,</span>
<span class="comments">;   pp_cubecollection__define, pp_titanbrowse_metadb__define, pp_titanbrowse_db__define, pp_titanbrowse__define</span>
<span class="comments">;   pp_mapwidget__define,pp_cubewidget__define,pp_spectrumwidget__define.</span>
<span class="comments">; </span>
<span class="comments">; Requires Catalist library, Coyote library (http://www.dfanning.com/catalyst/howtoinstall.html),</span>
<span class="comments">;    issmap_2009.tiff, vimsmap_2009.tiff</span>
<span class="comments">;    </span>
<span class="comments">; :Version: 20110719</span>
<span class="comments">;</span>
<span class="comments">; :Author: Paulo Penteado (pp.penteado@gmail.com)</span>
<span class="comments">;-</span>

<a id="pp_titanbrowse_gui::init:source"></a>function pp_titanbrowse_gui::init,mdbfiles,vis=vis
compile_opt idl2
self.version='20110719'
<span class="comments">;Initialize db</span>
self.db=obj_new('pp_titanbrowse',mdbfiles,vis=vis)
self.db->getproperty,version=dbversion
if (~obj_valid(self.db)) then return,0
<span class="comments">;Set up GUI</span>
<span class="comments">;Default window dimension</span>
DEFXSZ=800
DEFYSZ=600
self.DEFXSZ=DEFXSZ
self.DEFYSZ=DEFYSZ
ret=self->toplevelbase::init(/scroll,/size_events,$
 x_scroll_size=DEFXSZ,y_scroll_size=DEFYSZ,name='tlb',$
 title='pp_titanbrowse_gui gui'+self.version+' db'+dbversion)<span class="comments">;,mbar=mbar) ;Top-level widget</span>
<span class="comments">;edit=obj_new('buttonwidget',mbar,/menu,value='Edit')</span>
<span class="comments">;copy=obj_new('buttonwidget',edit,value='Copy',accelerator='Alt+C',name='copy')</span>
<span class="comments">;Define tabs</span>
tlb=self
tabw=obj_new('pp_titanbrowse_gui_tabwidget',tlb,scr_xsize=DEFXSZ,scr_ysize=DEFYSZ)
tlb->registerformessage,tabw,'resize'
tab1=obj_new('basewidget',tabw,row=1,/base_align_top,name='main_tab',title='Main')
tab2=obj_new('basewidget',tabw,column=1,name='cube_sel_tab',title='Cube selection')
tab3=obj_new('basewidget',tabw,column=1,name='pixel_sel_tab',title='Pixel selection')
<span class="comments">;Fourth tab</span>
<span class="comments">;maps=replicate({name:'',file:'',range:[-180d0,-90d0,180d0,90d0]},3)</span>
rpath=file_dirname(routine_filepath('pp_titanbrowse_gui__define'),/mark_directory)
<span class="comments">;maps[1].name='ISS 2007' & maps[1].file=rpath+'issmap_200710.tiff' & maps[1].range=[-180d0,-90d0,180d0,71d0]</span>
<span class="comments">;maps[2].name='VIMS (Barnes 2009)' & maps[2].file=rpath+'vimsmap_2009.tiff' & maps[2].range=[-181d0,-90d0,181d0,90d0] </span>
<span class="comments">;maps[0].name='none'</span>
maps=['none',rpath+'issmap_2009.tiff',rpath+'vimsmap_2009.tiff']
tab4=obj_new('pp_mapwidget',tabw,name='map',title='Map',scr_xsize=DEFXSZ,scr_ysize=DEFYSZ,maps=maps,dbobject=self.db)
tlb->registerformessage,tab4,'cubeselected'
<span class="comments">;Fifth tab</span>
self.db->getproperty,std=std
tab5=obj_new('pp_cubewidget',tabw,name='cube',title='Cube',scr_xsize=DEFXSZ,scr_ysize=DEFYSZ,std=*std)
tlb->registerformessage,tab5,'cubeselected'
<span class="comments">;First tab</span>
<span class="comments">;File tree</span>
tree=obj_new('pp_titanbrowse_gui_treewidget',tab1,/folder,xsize=DEFXSZ*0.4,ysize=DEFYSZ*0.95)
tlb->registerformessage,tree,'resize'
self.db->getproperty,mdbfiles=mdbfiles
mdbfiles=file_basename(mdbfiles,'.sav')
for i=0,n_elements(mdbfiles)-1 do void=obj_new('treewidget',tree,value=mdbfiles[i],$
 name='cube_tree',uvalue=i,/folder)
tab1col2=obj_new('basewidget',tab1,column=1,/base_align_left)
<span class="comments">;Cube information text</span>
text=obj_new('pp_titanbrowse_gui_textwidget',tab1col2,name='cube_info',$
 value='Cube information',scr_xsize=DEFXSZ*0.5,scr_ysize=DEFYSZ*0.6,frame=1,/scroll)
tlb->registerformessage,text,'resize'
tlb->registerformessage,text,'cube_select'
export_base=obj_new('basewidget',tab1col2,frame=1,column=1,/base_align_left)
void=obj_new('labelwidget',export_base,value='Export cube information')
export_cubeinfo_name=obj_new('fieldwidget',export_base,title='Export to variable:',name='export_name',/cr_events,/column)
export_cubeinfo_file=obj_new('buttonwidget',export_base,value='Export to text file',name='export_file')
<span class="comments">;Second tab</span>
cubesel=obj_new('pp_titanbrowse_gui_selectorwidget',tab2,/cube,name='cubeselector',xsize=DEFXSZ-25,ysize=DEFYSZ-40,frame=1,db=self.db)
<span class="comments">;Third tab</span>
pixelsel=obj_new('pp_titanbrowse_gui_selectorwidget',tab3,/pixel,name='pixelselector',xsize=DEFXSZ-25,ysize=DEFYSZ-40,frame=1,std=*std,db=self.db)
cubesel->registerformessage,pixelsel,'updatelist'
cubesel->registerformessage,cubesel,'updatelist'
pixelsel->registerformessage,cubesel,'updatelist'
pixelsel->registerformessage,pixelsel,'updatelist'
tlb->registerformessage,cubesel,'functionreplace'


self.selected_cube=[-1,-1]
self.cubeinfo_text=text
<span class="comments">;Update sizes of widgets that need it</span>
tlb->getproperty,geometry=geo
tlb->sendmessage,'resize',data=[geo,geo]
tlb->draw
tab4->update
tab4->draw
return,ret
end

<a id="pp_titanbrowse_gui::cleanup:source"></a>pro pp_titanbrowse_gui::cleanup
compile_opt idl2,hidden
obj_destroy,self.db
self->toplevelbase::cleanup
end

<a id="pp_titanbrowse_gui::eventhandler:source"></a>pro pp_titanbrowse_gui::eventhandler,event
<span class="comments">;Single handler for every event </span>
compile_opt idl2,hidden
<span class="comments">;print,'event:'</span>
<span class="comments">;help,event,/structure</span>
ename=strlowcase(event.name)
switch ename of
  'tlb': begin <span class="comments">;Resize event</span>
    self->getproperty,geometry=oldgeo
    self->setproperty,xsize=event.x,ysize=event.y,scr_xsize=event.x,scr_ysize=event.y
    self->getproperty,geometry=newgeo
    self->sendmessage,'resize',data=[newgeo,oldgeo] <span class="comments">;Tell everybody who needs to be resized</span>
    self->draw
    break
  end
  'cube_tree': begin <span class="comments">;Top level tree events (files)</span>
    event.id->getproperty,uvalue=uv,expanded=exp
    if (exp) then begin
      if (size(uv,/type) ne 7) then begin
        self.db->getproperty,odb=odb
        cmd=*(odb[uv]->getcmd())
        revs=cmd.rev[uniq(cmd.rev)]
        irevs=n_elements(revs) gt 1 ? value_locate(revs,cmd.rev) : replicate(0,size(cmd.rev,/dim))
        h=histogram(irevs,binsize=1,reverse_indices=ri)
        for i=0,n_elements(h)-1 do void=obj_new('treewidget',event.id,value=revs[i],$
          uvalue={pcmd:ptr_new(cmd),ri:ri[ri[i]:ri[i+1]-1],file:uv,odb:odb[uv]},name='cube_tree_rev',/folder)
        event.id->setproperty,uvalue=revs
      endif
    endif
    break
  end
  'cube_tree_rev': begin <span class="comments">;Secoond level tree events (revs)</span>
    event.id->getproperty,uvalue=uv,expanded=exp
    if (exp) then begin
      if (size(uv,/type) ne 7) then begin
        titles=(*uv.pcmd).seq_title[uv.ri]
        s=sort(titles)
        utitles=titles[uniq(titles,s)]
        ititles=n_elements(utitles) gt 1 ? value_locate(utitles,titles) : replicate(0,size(titles,/dim))
        h=histogram(ititles,binsize=1,reverse_indices=ri)
        for i=0,n_elements(h)-1 do void=obj_new('treewidget',event.id,value=utitles[i],$
         uvalue={ri:uv.ri[ri[ri[i]:ri[i+1]-1]],ind:i,odb:uv.odb,file:uv.file},name='cube_tree_seqt',/folder)
        event.id->setproperty,uvalue=utitles
      endif
    endif
    break
  end
  'cube_tree_seqt': begin <span class="comments">;Third level tree events (seq_titles)</span>
    event.id->getproperty,uvalue=uv,expanded=exp
    if (exp) then begin
      if (size(uv,/type) ne 7) then begin
        cubes=(uv.odb->filenames())[uv.ri]
        for i=0L,n_elements(cubes)-1 do void=obj_new('treewidget',event.id,value=cubes[i],$
         uvalue={ind:uv.ri[i],file:uv.file},name='cube_tree_cube')
        event.id->setproperty,uvalue=cubes
      endif
    endif
    break
  end
  'cube_tree_cube': begin <span class="comments">;Fourth level tree events (cubes)</span>
    event.id->getproperty,uvalue=uv,select=select
    if (select) then begin
      self.selected_cube=[uv.file,uv.ind]
      self->sendmessage,'cube_select',data=self
      if (event.clicks eq 2) then begin
        cubeinfo=self.db->getcubeinfo(file=uv.file,cube_index=uv.ind)
        self->sendmessage,'functionreplace',data="cmd.prod_id eq '"+cubeinfo.prod_id+"'"
        self.db->getproperty,odb=odb
        self->sendmessage,'cubeselected',data=odb[uv.file]->getcube(uv.ind)
        ptr_free,self.cubeinfo
        self.cubeinfo=ptr_new(cubeinfo)
      endif
    endif
    break
  end
  'pixel_button' : <span class="comments">;Fall through to be handled by the next clause</span>
  'cube_button': begin
    event.id->getproperty,uvalue=uv
    widget_control,/hourglass
    case uv of 
    'clear' : if (ename eq 'cube_button') then self.db->selectcubes,/none else self.db->selectpixels,/none 
    'all' : if (ename eq 'cube_button') then self.db->selectcubes,/all else self.db->selectpixels,/all
    'propagate' : if (ename eq 'cube_button') then self.db->selectpixels,/all else self.db->selectcubes,/pixel
    'freezeswitch' : begin
      event.handler->getproperty,frozen=frozen
      event.handler->setproperty,frozen=~frozen
    end
    endcase
<span class="comments">;Update own widget and the other with the new selection</span>
    event.handler->sendmessage,'updatelist',data=self.db
    break
  end
  'pixelselector_functext' : <span class="comments">;Fall through to be handled by the next clause</span>
  'cubeselector_functext' : begin
    widget_control,/hourglass
    event.id->getproperty,value=val
    if (ename eq 'cubeselector_functext') then begin
      pexpr=self.db->parseexpr(val,/cube)
      widget_control,/hourglass
      self.db->selectcubes,pexpr,count=count
    endif else begin
      pexpr=self.db->parseexpr(val,/pixel)
      widget_control,/hourglass
      self.db->selectpixels,pexpr,count=count
    endelse
    event.handler->sendmessage,'updatelist',data=self.db
    break
  end
  'export_name' : if (ptr_valid(self.cubeinfo)) then begin
    name=idl_validname(*event.value)
    if (name ne '') then begin
      cubeinfo=*self.cubeinfo
      savetomain,cubeinfo,name
    endif
    break
  endif
  'export_file' : if (obJ_valid(self.cubeinfo_text)) then begin
    deffile=file_basename((*self.cubeinfo).cubefile,'.cub')+'_cubeinfo.txt'
    self->getproperty,id=id
    file=dialog_pickfile(default_extension='.txt',filter=['*.txt','*.TXT'],display_name='Export cube to file',$
     /overwrite_prompt,dialog_parent=id,/write,file=deffile)
    if (file ne '') then begin
      self.cubeinfo_text->getproperty,value=val
      openw,unit,file,/get_lun
      printf,unit,val,format='(A0)'
      free_lun,unit
    endif
  endif
  else:
  endswitch
end

<a id="pp_titanbrowse_gui_tabwidget::messagehandler:source"></a>pro pp_titanbrowse_gui_tabwidget::messagehandler,title,sender=sender,data=data
<span class="comments">;Called when resizing is needed</span>
<span class="comments">;Call to draw is left to the sender</span>
compile_opt idl2,hidden
self->getproperty,scr_xsize=sxs,scr_ysize=sys
xb=data[1].xsize-sxs & yb=data[1].ysize-sys
self->setproperty,scr_xsize=data[0].xsize-xb,scr_ysize=data[0].ysize-yb
end

<a id="pp_titanbrowse_gui_treewidget::messagehandler:source"></a>pro pp_titanbrowse_gui_treewidget::messagehandler,title,sender=sender,data=data
<span class="comments">;Called when resizing is needed</span>
<span class="comments">;Call to draw is left to the sender</span>
compile_opt idl2,hidden
self->getproperty,scr_xsize=sxs,scr_ysize=sys
xr=(1d0*sxs)/data[1].xsize & yb=data[1].ysize-sys
self->setproperty,scr_xsize=data[0].xsize*xr,scr_ysize=data[0].ysize-yb
end

<a id="pp_titanbrowse_gui_textwidget::messagehandler:source"></a>pro pp_titanbrowse_gui_textwidget::messagehandler,title,sender=sender,data=data
<span class="comments">;Called when resizing is needed</span>
<span class="comments">;Call to draw on resize is left to the sender</span>
compile_opt idl2,hidden
case title of
  'resize': begin <span class="comments">;Update size</span>
    self->getproperty,scr_xsize=sxs,scr_ysize=sys
    if (self.minyborder eq 0) then self.minyborder=data[1].ysize-sys
    xr=(1d0*sxs)/data[1].xsize & yb=data[1].ysize-sys
    self->setproperty,scr_xsize=data[0].xsize*xr,scr_ysize=data[0].ysize-yb
  end
  'cube_select': begin <span class="comments">;Update cube information </span>
    cubeinfo=data.db->getcubeinfo(file=data.selected_cube[0],cube_index=data.selected_cube[1])
<span class="comments">;Format cubeinfo for output</span>
    text0='Cube information for '+cubeinfo.cubefile
    tn=tag_names(cubeinfo) & nt=n_tags(cubeinfo)
    text1=strarr(nt-2)
    j=0
    for i=0,nt-1 do if (size(cubeinfo.(i),/type) ne 8) then begin
      text1[j]=' '+string(tn[i],format='(A23)')+'   '+strcompress(string(cubeinfo.(i)),/remove) 
      j++
    endif 
    tn=tag_names(cubeinfo.back_min) & nt=n_tags(cubeinfo.back_min)
    text2=strarr(nt*2)
    text3=strarr(nt)
    for i=0,nt-1 do begin
      text2[i*2]=' '+string('MIN_'+tn[i],format='(A23)')+'   '+strcompress(string(cubeinfo.back_min.(i)),/remove) 
      text2[i*2+1]=' '+string('MAX_'+tn[i],format='(A23)')+'   '+strcompress(string(cubeinfo.back_max.(i)),/remove)
    endfor
    text=[text0,text1,text2]
    self->setproperty,value=text
  end
  endcase
end

<a id="pp_titanbrowse_gui_selectorwidget::init:source"></a>function pp_titanbrowse_gui_selectorwidget::init,parent,cube=cube,pixel=pixel,std=std,db=db,_ref_extra=rex
<span class="comments">;Compound widget for cube or pixel selection</span>
<span class="comments">;Extra keywords go to the base widget initializer</span>
compile_opt idl2,hidden
<span class="comments">;Defaults</span>
cube=keyword_set(cube) ? 1B : keyword_set(pixel) ? 0B : 1B
pixel=~cube
self.frozen=1B

<span class="comments">;Initialize the base</span>
ret=self->basewidget::init(parent,_strict_extra=rex,column=1)
self->getproperty,name=basename,geometry=geo
<span class="comments">;Create the child widgets</span>
row1=obj_new('basewidget',self,row=1,frame=1,/base_align_left)
<span class="comments">;void=obj_new('labelwidget',row1,value='Function for selection')</span>
<span class="comments">;func=obj_new('textwidget',row1,name=basename+'_functext',/editable,/scroll,scr_xsize=geo.scr_xsize-20)</span>
func=obj_new('fieldwidget',row1,name=basename+'_functext',title='Function for selection',/column,scr_xsize=geo.scr_xsize-20,/cr_events)
row1->getproperty,geometry=row1geo
row2=obj_new('basewidget',self,column=2)
col1=obj_new('basewidget',row2,frame=1,row=2,scr_ysize=geo.ysize-row1geo.ysize-60)
void=obj_new('labelwidget',col1,value='Available variables')
tree=obj_new('treewidget',col1,name=basename+'_vartree',/folder,scr_ysize=geo.ysize-row1geo.ysize-80)
col1->getproperty,geometry=col1geo
col2=obj_new('basewidget',row2,row=3,frame=1,xsize=geo.xsize-col1geo.xsize-30,/base_align_left)
list_title=obj_new('labelwidget',col2,value='Selected '+(cube ? 'cube' : 'pixel')+'s         ')
list=obj_new('textwidget',col2,/scroll,scr_xsize=geo.xsize-col1geo.xsize-30,scr_ysize=geo.ysize-row1geo.ysize-160,font='Courier')
row3=obj_new('basewidget',col2,row=1,/base_align_top)
tlabel=cube ? 'cube' : 'pixel'
button_base=obj_new('basewidget',row3,row=2,/base_align_top)
void=obj_new('buttonwidget',button_base,value='Clear list',/dynamic_resize,name=tlabel+'_button',uvalue='clear',$
 tooltip='Deselect all '+tlabel+'s')
frozenswitch=obj_new('buttonwidget',button_base,value='Unfreeze selection display',/dynamic_resize,name=tlabel+'_button',uvalue='freezeswitch',$
 tooltip='Switch on/off updating the selection text display')
void=obj_new('buttonwidget',button_base,value='Select all',/dynamic_resize,name=tlabel+'_button',uvalue='all',$
 tooltip=cube ? 'Select every cube in the database' : 'Select every pixel of the selected cubes')
void=obj_new('buttonwidget',button_base,value='Propagate selection',/dynamic_resize,name=tlabel+'_button',uvalue='propagate',$
 tooltip=cube ? 'Select every pixel of the selected cubes' : 'Keep selected only the cubes with pixels in the list (and clear the pixel list)')
export_base=obj_new('basewidget',row3,frame=1,column=1,/base_align_left)
void=obj_new('labelwidget',export_base,value='Export list')
export_cube_name=obj_new('fieldwidget',export_base,title='Export to variable:',name=basename+'_export_name',/cr_events,/column)
export_cube_file=obj_new('buttonwidget',export_base,value='Export to text file',name=basename+'_export_file')
if (cube) then export_cubes_dir=obj_new('buttonwidget',row3,value='Export cube files',name=basename+'_export_cubes_dir')


<span class="comments">;Populate the tree</span>
if (cube) then begin
<span class="comments">;Figure out the variable names</span>
  cmd={pp_titanbrowse_cmd}
  nt=n_tags(cmd) & tn=tag_names(cmd)
  vars='' & j=0
  for i=0,nt-1 do if (size(cmd.(i),/type) ne 8) then vars=[vars,tn[i]]
  vars=vars[1:*] & lvars='cmd.'+strlowcase(vars)
  nt=n_tags(cmd.back_min) & tn=tag_names(cmd.back_min)
  minback='cmd.back_min.'+strlowcase(tn)
  maxback='cmd.back_max.'+strlowcase(tn)
<span class="comments">;Put the names into the tree</span>
  for i=0,n_elements(vars)-1 do void=obj_new('treewidget',tree,value=vars[i],name=basename+'_vartree_cube',uvalue=lvars[i])
  backmin=obj_new('treewidget',tree,value='Backplanes_min',name=basename+'_vartree_cube_back',/folder)
  backmax=obj_new('treewidget',tree,value='Backplanes_max',name=basename+'_vartree_cube_back',/folder)
  for i=0,nt-1 do begin
    void=obj_new('treewidget',backmin,value=tn[i],name=basename+'_vartree_cube',uvalue=minback[i])
    void=obj_new('treewidget',backmax,value=tn[i],name=basename+'_vartree_cube',uvalue=maxback[i])
  endfor
endif else begin
<span class="comments">;Figure out the variable names</span>
<span class="comments">;Core bands</span>
  vbands=' _c_'+strtrim(sindgen(std.bands),2)+'_ '
  nbands=strtrim(sindgen(std.bands),2)+' ('+string(*std.wavs,format='(F6.4)')+string(181B)+'m)'
<span class="comments">;Backplanes</span>
  vbacks=' _b_'+*std.bnames+'_ '
  nbacks=strupcase(*std.bnames) 
<span class="comments">;Put the names into the tree</span>
  core=obj_new('treewidget',tree,value='Core bands',name=basename+'_vartree_pixel_core',/folder)
  back=obj_new('treewidget',tree,value='Backplanes',name=basename+'_vartree_pixel_back',/folder)
  for i=0,n_elements(vbands)-1 do void=obj_new('treewidget',core,value=nbands[i],uvalue=vbands[i],name=basename+'_vartree_pixel')
  for i=0,n_elements(vbacks)-1 do void=obj_new('treewidget',back,value=nbacks[i],uvalue=vbacks[i],name=basename+'_vartree_pixel')
endelse
<span class="comments">;Save things into self</span>
self.cube=cube
self.pixel=pixel
self.vartree=tree
self.selfunction=func
self.list=list
self.list_title=list_title
self.db=db
self.frozenswitch=frozenswitch
return,ret
end

<a id="pp_titanbrowse_gui_selectorwidget::getproperty:source"></a>pro pp_titanbrowse_gui_selectorwidget::getproperty,frozen=frozen,_ref_extra=rex
compile_opt idl2,hidden
if arg_present(frozen) then frozen=self.frozen
if (n_elements(rex) gt 0) then self->basewidget::getproperty,_strict_extra=rex 
end

<a id="pp_titanbrowse_gui_selectorwidget::setproperty:source"></a>pro pp_titanbrowse_gui_selectorwidget::setproperty,list=list,nsel=nsel,frozen=frozen,_ref_extra=rex
compile_opt idl2,hidden
if (n_elements(nsel) gt 0) then begin
  self.list->setproperty,value=n_elements(list) gt 0 ? list : ''
  val='Selected '+(self.cube ? 'cube' : 'pixel')+'s: '+strtrim(string(nsel),2)
  self.list_title->setproperty,value=val
endif
if (n_elements(frozen) eq 1) then begin
  self.frozen=frozen
  self.frozenswitch->setproperty,value=frozen ? 'Unfreeze selection display' : 'Freeze selection display'
endif
if (n_elements(rex) gt 0) then self->basewidget::setproperty,_strict_extra=rex
end

<a id="pp_titanbrowse_gui_selectorwidget::eventhandler:source"></a>pro pp_titanbrowse_gui_selectorwidget::eventhandler,event
<span class="comments">;Intercepts events to update the text in the function text widget, then passes the event on </span>
compile_opt idl2,hidden
if ((event.name eq 'cubeselector_vartree_cube')||(event.name eq 'pixelselector_vartree_pixel'))&&(event.clicks eq 2) then begin
  event.id->getproperty,uvalue=uv
  self.selfunction->getproperty,value=text
  <span class="comments">;self.selfunction->setproperty,value=text+' '+uv+' '</span>
  self.selfunction->setproperty,value=text+uv
endif
ename=strlowcase(event.name)
self->getproperty,name=basename
case ename of
  basename+'_export_name' : if (obj_valid(self.list)) then begin
    name=idl_validname(*event.value)
    if (name ne '') then begin
      widget_control,/hourglass
      list=self.pixel ? self.db->getselectedpixels() : self.db->getselectedcubes()
      savetomain,list,name
    endif
  endif
  basename+'_export_file' : if (obj_valid(self.list)) then begin
    self.list->getproperty,value=val
    self->getproperty,id=id
    file=dialog_pickfile(default_extension='.txt',filter=['*.txt','*.TXT'],display_name='Export cube list to file',$
     /overwrite_prompt,file='titanbrowse_'+(self.cube ? 'cube' : 'pixel')+'list',dialog_parent=id,/write)
    if (file ne '') then begin
      openw,unit,file,/get_lun
      printf,unit,val,format='(A0)'
      free_lun,unit
    endif
  endif
  basename+'_export_cubes_dir' : if (obj_valid(self.list)) then begin
    self.list->getproperty,value=val
    self->getproperty,id=id
    dir=dialog_pickfile(display_name='Export cube files to directory',/directory,dialog_parent=id)
    if (dir ne '') then begin
      widget_control,/hourglass
      list=self.pixel ? self.db->getselectedpixels() : self.db->getselectedcubes()
      for i=0,n_elements(list)-1 do begin
        file=dir+path_sep()+list[i]->getproperty(/file)
        print,'Writing cube ',file
        list[i]->write,file
      endfor
    endif
  endif
  else :
endcase
<span class="comments">;Pass the event ahead</span>
self->getproperty,parents=par
par->eventhandler,event
end

<a id="pp_titanbrowse_gui_selectorwidget::messagehandler:source"></a>pro pp_titanbrowse_gui_selectorwidget::messagehandler,title,sender=sender,data=data
compile_opt idl2,hidden
if (title eq 'updatelist') then begin
  if (self.cube) then begin
    if (self.frozen) then begin
      data->getproperty,nselcubes=nselcubes
      self->setproperty,nsel=nselcubes    
    endif else begin
      widget_control,/hourglass
      data->getproperty,cubelist=cubelist,nselcubes=nselcubes
      self->setproperty,list=cubelist,nsel=nselcubes
    endelse
  endif else begin
    if (self.frozen) then begin
      data->getproperty,nselpixels=nselpixels
      self->setproperty,nsel=nselpixels
    endif else begin
      widget_control,/hourglass
      data->getproperty,pixellist=pixellist,nselpixels=nselpixels
      self->setproperty,list=pixellist,nsel=nselpixels
    endelse
  endelse
endif
if (title eq 'functionreplace') then self.selfunction->setproperty,value=data
end

<a id="pp_titanbrowse_gui::getproperty:source"></a>pro pp_titanbrowse_gui::getproperty,db=db,_ref_extra=rex,version=version
compile_opt idl2,hidden
if (arg_present(db)) then db=self.db
if (arg_present(version)) then version=self.version
if (n_elements(rex) gt 0) then self->toplevelbase::getproperty,_strict_extra=rex
end

<a id="pp_titanbrowse_gui__define:source"></a>pro pp_titanbrowse_gui__define
compile_opt idl2
void={pp_titanbrowse_gui,inherits toplevelbase,db:obj_new(),selected_cube:lonarr(2),DEFXSZ:0,DEFYSZ:0,$
 cubeinfo:ptr_new(),cubeinfo_text:obj_new(),version:''}
void={pp_titanbrowse_gui_tabwidget,inherits tabwidget} <span class="comments">;Simple extension for tabwidget to provide a messagehandler</span>
void={pp_titanbrowse_gui_treewidget,inherits treewidget} <span class="comments">;Simple extension for treewidget to provide a messagehandler</span>
void={pp_titanbrowse_gui_textwidget,inherits textwidget,minyborder:0} <span class="comments">;Simple extension for textidget to provide a messagehandler</span>
void={pp_titanbrowse_gui_selectorwidget,inherits basewidget,$ <span class="comments">;Compound widget for cube or pixel selection</span>
 vartree:obj_new(), selfunction:obj_new(), list:obj_new(),cube:0B,pixel:0B,list_title:obj_new(),db:obj_new(),frozen:0B,frozenswitch:obj_new(),$
 inherits IDL_Object}
end
</code>
    </div>
  </body>
</html>